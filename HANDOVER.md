# History Future Now — Handover to Cursor

## What This Project Is

**History Future Now** (historyfuturenow.com) is a static website with 54 long-form analytical essays about demographics, geopolitics, energy, economics, and society. Each essay is backed by interactive Chart.js data visualisations — 113 charts in total across 34 articles. The site is authored by Tristan Fischer and deployed via GitHub Pages.

## Repository

- **GitHub**: `https://github.com/tristanfischer-ux/historyfuturenow.git`
- **Local clone**: `~/Downloads/hfn-site` (this is the deployment repo)
- **Build system**: Lives on Claude's container at `/home/claude/hfn-build` — Tristan does NOT have this locally. The build system needs to be recreated or the build outputs need to be maintained manually.

## Architecture

### Build System (Python)

The site is generated by a Python build system with two core files:

1. **`build.py`** (815 lines) — The static site generator
   - Reads markdown essays from `essays/` directory
   - Parses YAML frontmatter (title, part, excerpt, etc.)
   - Converts markdown to HTML
   - Injects Chart.js interactive charts at specified positions
   - Generates article pages, section pages, and the homepage
   - Generates SEO files: `sitemap.xml`, `robots.txt`, `llms.txt`
   - Adds JSON-LD structured data and canonical URLs to every page

2. **`chart_defs.py`** (2,192 lines) — All 113 chart definitions
   - Each chart is a Python dict with: `id`, `figure_num`, `title`, `desc`, `source`, `position`, `js`
   - The `js` field contains raw Chart.js JavaScript that gets injected into the page
   - Charts use a theming system with colour variables: `C.accent`, `C.blue`, `C.amber`, `C.green`, `C.purple`, `C.teal`, `C.rose`
   - Helper functions: `ds()` creates dataset objects, `legend`/`noLegend`/`tooltipStyle` are shared config
   - Charts are keyed by article slug
   - The `position` field uses `after_para_N` or `after_heading:Text` to place charts in the article body
   - A flatten step at the end of `get_all_charts()` unwraps any accidentally nested lists

### Essay Format

Each essay is a `.md` file in `essays/` with YAML frontmatter:

```yaml
---
title: "The Great Emptying: How Collapsing Birth Rates Will Reshape Power, Politics And People"
part: "Society"
excerpt: "In a small town in southern Italy..."
---

Markdown body here...
```

The `part` field maps to one of four sections:
- **Natural Resources** (11 articles) — slug: `natural-resources`, colour: `#0d9a5a`
- **Global Balance of Power** (13 articles) — slug: `balance-of-power`, colour: `#2563eb`
- **Jobs & Economy** (10 articles) — slug: `jobs-economy`, colour: `#b8751a`
- **Society** (20 articles) — slug: `society`, colour: `#7c3aed`

### Chart Injection System

The build system injects charts into articles using a position system:

- `after_para_6` — Insert chart after the 6th `<p>` tag
- `after_heading:The Scale of the Collapse` — Insert after a heading containing that text
- `end` — Append to end of article

The `make_chart_html()` function auto-detects chart sizing:
- **Standard**: 16:9 aspect, min-height 360px
- **Tall** (auto-applied for horizontal bars with 10+ labels or 5+ datasets): 4:3, min-height 480px
- **Extra-tall** (horizontal bars with 20+ labels): 2:3, min-height 600px

On mobile (≤640px), aspect-ratio is set to `auto` and min-heights are enforced: 350px / 500px / 650px.

### Chart Theme System

Charts use a shared JavaScript prelude that's injected at the top of each article's `<script>` block:

```javascript
const C = {text:'#1a1815', dim:'#8a8479', faint:'#b8b2a8', grid:'#f2eeea',
  accent:'#c43425', blue:'#2563eb', amber:'#b8751a', green:'#0d9a5a',
  purple:'#7c3aed', teal:'#0d9488', rose:'#e11d48'};
const noLegend = {display:false};
const legend = {display:true, position:'bottom', labels:{...}};
const tooltipStyle = {backgroundColor:'#1a1815ee', ...};
function ds(label, data, color, dash) { ... }  // Dataset factory
```

## Deployment

The site is deployed via GitHub Pages. The workflow is:

1. Build outputs go to `/home/claude/hfn-site/`
2. Files are tarred: `tar czf hfn-full.tar.gz articles/ css/ index.html ...`
3. Tristan downloads the tar, extracts into `~/Downloads/hfn-site`
4. `git add -A && git commit -m "message" && git push --force origin main`

The output directory structure:
```
hfn-site/
├── index.html                  # Homepage
├── natural-resources.html      # Section pages
├── balance-of-power.html
├── jobs-economy.html
├── society.html
├── sitemap.xml                 # SEO
├── robots.txt                  # SEO + AI crawler permissions
├── llms.txt                    # AI crawler content index
├── css/
│   └── style.css               # All styles (22KB)
├── favicon.svg
└── articles/
    ├── the-great-emptying-how-collapsing-birth-rates-will-reshape-power-politics-and-people.html
    ├── europe-rearms-why-the-continent-that-invented-total-war-is-spending-800-billion-on-defence.html
    └── ... (54 total)
```

## What Was Built in This Session

### New Articles Written & Deployed
1. **Europe Rearms** (~4,000 words, 3 charts) — Why Europe is spending €800B on defence
2. **The Death of the Fourth Estate** (~4,500 words, 4 charts) — Collapse of newspapers and democracy
3. **The Great Emptying** (~3,000 words, 10 charts) — Global fertility collapse and its consequences

### Homepage Redesign
- **New "Latest" section** at top — warm cream background with white cards, pulsing red dot, shows 3 newest articles automatically (sorted by file modification time)
- **Expanded Data Stories carousel** — from 5 to 12 mini-chart cards
- **Featured article banner** updated to The Great Emptying
- **Stats bar** auto-updates: 54 articles, 113 charts

### SEO & AI Crawler Infrastructure
- **sitemap.xml** — 59 URLs with priorities
- **robots.txt** — Explicitly allows GPTBot, Claude-Web, PerplexityBot, Google-Extended, Applebot-Extended
- **llms.txt** — Structured content index for AI crawlers (title, URL, section, reading time, excerpt for every article)
- **JSON-LD** structured data (Article schema) on every article page + WebSite schema on homepage
- **Canonical URLs** on every page
- **Enhanced meta tags**: `summary_large_image` Twitter cards, `article:author`, `og:locale`

### Chart Sizing Fixes
- Auto-detection of horizontal bar charts that need more height
- Three size tiers: standard / tall / xtall
- Mobile-specific sizing with `aspect-ratio: auto` and enforced min-heights
- Affects 19 articles across the site

## Key Technical Details

### Adding a New Article

1. Write markdown with YAML frontmatter, save to `essays/`
2. Add chart definitions to `chart_defs.py` keyed by slug
3. Run `python3 build.py`
4. Deploy the output

### Adding Charts to an Existing Article

In `chart_defs.py`, find or create the article's slug key and add chart dicts:

```python
charts['article-slug'] = [
    {
        'id': 'myChart1',
        'figure_num': 1,
        'title': 'Chart Title',
        'desc': 'Description shown below title.',
        'source': 'Source attribution.',
        'position': 'after_para_10',
        'js': """(()=>{const ctx=document.getElementById('myChart1');
new Chart(ctx,{type:'bar',data:{...},options:{...}});
})();"""
    },
]
```

### The `position` Gotcha

Chart positions reference paragraph numbers in the *rendered HTML*, not the markdown. If you add/remove paragraphs in the essay, chart positions may shift. The system counts `<p>` tags sequentially.

### CSS Variables Used

```css
--serif: 'Playfair Display', serif;
--sans: 'Source Sans 3', sans-serif;
--mono: 'IBM Plex Mono', monospace;
--text: #1a1815;
--text-dim: #5c574f;
--text-faint: #8a8479;
--bg: #fefcf9;
--bg-warm: #faf8f5;
--surface: #f5f1ec;
--border: #e8e4df;
--border-light: #f2eeea;
--accent: #c43425;
```

### External Dependencies

- **Chart.js 4.4.7** — CDN loaded
- **chartjs-plugin-annotation 3.0.1** — For reference lines (e.g. "replacement rate 2.1")
- **Google Fonts**: Playfair Display, Source Sans 3, IBM Plex Mono
- **Python packages** (build only): `markdown`, `pyyaml`

## Audio Generation

The site generates audio narrations and (optionally) debate audio for each essay. Two TTS backends are supported:

### Backend 1: Google Cloud TTS (Original)

- Uses Neural2 British voices (`en-GB-Neural2-B` male, `en-GB-Neural2-C` female)
- Requires `gcloud` CLI authentication and a GCP project
- Has per-character costs and rate limits
- Run: `python3 generate_audio.py` (default backend)

### Backend 2: Voicebox (Local, Free)

[Voicebox](https://github.com/jamiepine/voicebox) is an open-source voice cloning studio powered by Qwen3-TTS. It runs entirely on local hardware — no API costs, no rate limits, no data leaving your machine.

**Key files:**

| File | Purpose |
|------|---------|
| `voicebox_tts.py` | REST API client for the Voicebox server |
| `setup_voicebox_profiles.py` | Interactive setup for creating voice profiles |
| `generate_audio.py --backend voicebox` | Article narration via Voicebox |
| `generate_discussions.py audio --backend voicebox` | Debate audio via Voicebox |

**Setup:**

```bash
# 1. Install & run Voicebox (https://github.com/jamiepine/voicebox/releases)
#    Or run the backend directly:
cd voicebox/backend && pip install -r requirements.txt
python -m backend.server --host 0.0.0.0 --port 8000

# 2. Download a model in Voicebox (Qwen3-TTS 1.7B recommended)

# 3. Create voice profiles and add audio samples:
python3 setup_voicebox_profiles.py --create-all
python3 setup_voicebox_profiles.py --add-sample <PROFILE_ID> sample.wav "transcript"

# 4. Set environment variables (from the output of --create-all):
export VOICEBOX_PROFILE_MALE=<id>
export VOICEBOX_PROFILE_FEMALE=<id>
export VOICEBOX_PROFILE_JAMES=<id>    # optional, for debates
export VOICEBOX_PROFILE_ELENA=<id>    # optional, for debates

# 5. Generate audio:
python3 generate_audio.py --backend voicebox                    # all articles
python3 generate_audio.py --backend voicebox --article SLUG     # one article
python3 generate_discussions.py audio --backend voicebox         # debate audio
```

**Configuration (environment variables):**

| Variable | Default | Description |
|----------|---------|-------------|
| `VOICEBOX_URL` | `http://localhost:8000` | Voicebox server URL |
| `VOICEBOX_PROFILE_MALE` | — | Profile ID for male British narrator |
| `VOICEBOX_PROFILE_FEMALE` | — | Profile ID for female British narrator |
| `VOICEBOX_PROFILE_JAMES` | — | Profile ID for James (debate speaker) |
| `VOICEBOX_PROFILE_ELENA` | — | Profile ID for Elena (debate speaker) |
| `VOICEBOX_MODEL_SIZE` | `1.7B` | Model size: `1.7B` or `0.6B` |
| `VOICEBOX_TIMEOUT` | `300` | Generation request timeout (seconds) |

**Why Voicebox over cloud TTS:**

- **Cost:** Free — no per-character charges
- **Voice cloning:** Create distinctive, consistent voices from short audio samples
- **Privacy:** Audio never leaves the machine
- **No rate limits:** Generate as fast as your GPU allows
- **Instruct mode:** Control delivery style per-utterance (dry, emphatic, sardonic, etc.)
- **Existing backends unaffected:** Google Cloud TTS and Gemini TTS remain the defaults

## Known Issues / Things to Watch

1. **Build system is ephemeral** — It only exists on Claude's container which resets between sessions. Either recreate it in Cursor's workspace or keep a local copy of `build.py`, `chart_defs.py`, and the `essays/` directory.

2. **File modification time ordering** — The "Latest" section on the homepage sorts articles by `.md` file mtime. If files are copied/recreated, all mtimes reset and ordering breaks. Consider adding a `date` field to the YAML frontmatter instead.

3. **Chart position fragility** — If essay text changes, `after_para_N` positions may shift. The `after_heading:Text` format is more robust.

4. **No images** — The site uses no raster images (except for the docx-extracted PNGs that were replaced with Chart.js charts). The `images/great-emptying/` directory from an earlier attempt may still exist in the repo and can be deleted.

5. **The CSS** is a single 22KB file. The Latest section styles are near the bottom (around line 258).

6. **`--force` pushes** — Tristan has been using `git push --force` throughout. The repo has a simple linear history on `main`.
